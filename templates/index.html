<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ANPR Flask Interface</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        body { font-family: system-ui, sans-serif; margin: 0; padding: 0; background-color: #f0f2f5; display: flex; flex-direction: column; align-items: center; font-size: 14px; }
        .top-bar { background-color: #1877f2; color: white; padding: 10px 20px; width: 100%; box-shadow: 0 2px 4px rgba(0,0,0,0.1); text-align: center; margin-bottom: 15px; }
        .top-bar h1 { margin: 0; font-size: 22px; }
        .main-container { display: flex; flex-wrap: wrap; justify-content: center; width: 100%; max-width: 1200px; padding: 10px; gap:15px;}
        .control-panel, .feed-panel, .info-panel { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .control-panel { flex: 1; min-width: 300px; max-width:400px; }
        .feed-panel { flex: 2; min-width: 320px; display: flex; flex-direction: column; align-items: center; }
        .info-panel { flex: 1; min-width: 300px; max-width:400px; display:flex; flex-direction:column; }

        label { display: block; margin-top: 12px; margin-bottom: 4px; font-weight: 600; }
        input[type="text"], select { width: calc(100% - 20px); padding: 9px; margin-bottom: 8px; border-radius: 6px; border: 1px solid #dddfe2; font-size: 14px; box-sizing: border-box; background-color: white; }
        button { background-color: #1877f2; color: white; padding: 9px 14px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600; width: 100%; transition: background-color 0.2s; margin-top:8px; }
        button:hover { background-color: #166fe5; }
        .button-group { display: flex; gap: 8px; margin-bottom:12px;}
        .button-group button { width: 100%;}

        #videoFeedContainer { width:100%; text-align: center; background-color: #000; padding: 5px; border-radius: 8px; box-shadow: 0 1px 2px rgba(0,0,0,0.2); min-height: 240px; display: flex; justify-content: center; align-items: center; margin-bottom:15px; }
        #videoFeed { display: block; max-width: 100%; height: auto; border-radius: 6px; background-color: #333; }

        .status { text-align: center; margin-top: 8px; font-size: 12px; color: #606770; min-height:16px; }
        #phoneCameraPreviewContainer { margin-top:12px; text-align:center; }
        #phoneCameraPreview { border:1px solid #ccc; border-radius:6px; max-width:100%; height:auto; background-color:#eee; max-height: 180px;}
        .hidden { display: none; }

        .log-area-container { margin-top:15px; }
        #logArea { width: calc(100% - 20px); height: 150px; background-color: #282c34; color: #abb2bf; font-family: 'Courier New', Courier, monospace; font-size: 11px; border: 1px solid #ccc; border-radius: 4px; padding: 8px; overflow-y: scroll; white-space: pre-wrap; box-sizing:border-box; }
        .log-info { color: #61afef; } /* Blue for info */
        .log-warn { color: #e5c07b; } /* Yellow for warn */
        .log-error { color: #e06c75; } /* Red for error */
        .log-success { color: #98c379; } /* Green for success */

        .last-capture-container { margin-top:15px; text-align:center;}
        #lastCapturedImage { max-width: 100%; max-height:150px; border: 1px solid #ddd; border-radius: 4px; margin-top: 5px; background-color:#eee; }
        #lastCapturedText { font-weight: bold; margin-top:5px; font-size:13px; }
        h2 { font-size: 18px; color: #333; margin-top:0; margin-bottom:10px; border-bottom: 1px solid #eee; padding-bottom:5px;}
    </style>
</head>
<body>
<div class="top-bar">
    <h1>ANPR Web Interface</h1>
</div>

<div class="main-container">
    <div class="control-panel">
        <h2>Camera Control</h2>
        <div>
            <label for="ip_camera_url">IP Camera URL (or 'local'):</label>
            <input type="text" id="ip_camera_url" name="ip_camera_url" value="local"
                   placeholder="e.g., http://192.168.X.X/video">
        </div>
        <div>
            <label for="camera_id_input">Camera ID:</label>
            <input type="text" id="camera_id_input" name="camera_id_input" value="default_cam"
                   placeholder="e.g., cam1_front_gate">
        </div>
        <div>
            <label for="location_select">Camera Location:</label>
            <select id="location_select" name="location_select">
                {% if camera_locations %}
                {% for location in camera_locations %}
                <option value="{{ location.name }}" data-description="{{ location.description | default('', true) }}">
                    {{ location.name }}
                </option>
                {% endfor %}
                {% else %}
                <option value="Main Gate">Main Gate (Default)</option>
                {% endif %}
            </select>
        </div>
        <div class="button-group">
            <button id="startIpCamButton">Use IP / Server Cam</button>
            <button id="startPhoneCamButton">Use This Phone's Camera</button>
        </div>
        <div class="status" id="streamStatus">Select a camera source.</div>

        <div id="phoneCameraPreviewContainer" class="hidden">
            <p style="font-size:12px; color:#606770; margin-bottom:5px;">Your phone camera preview (raw):</p>
            <video id="phoneCameraPreview" width="240" autoplay playsinline muted></video>
        </div>
    </div>

    <div class="feed-panel">
        <h2>Live ANPR Feed</h2>
        <div id="videoFeedContainer">
            <img id="videoFeed" src="" alt="Processed Video Stream">
        </div>
    </div>

    <div class="info-panel">
        <h2>Last Captured Plate</h2>
        <div class="last-capture-container">
            <img id="lastCapturedImage" src="" alt="Last saved plate">
            <div id="lastCapturedText">Text: N/A (Score: N/A)</div>
        </div>

        <div class="log-area-container">
            <h2>Event Log</h2>
            <div id="logArea"></div>
        </div>
    </div>
</div>

<script>
    const videoFeedImg = document.getElementById('videoFeed');
    const ipCameraUrlInput = document.getElementById('ip_camera_url');
    const cameraIdInput = document.getElementById('camera_id_input');
    const locationSelect = document.getElementById('location_select'); // Get location select dropdown
    const streamStatus = document.getElementById('streamStatus');
    const startIpCamButton = document.getElementById('startIpCamButton');
    const startPhoneCamButton = document.getElementById('startPhoneCamButton');

    const phoneCameraPreview = document.getElementById('phoneCameraPreview');
    const phoneCameraPreviewContainer = document.getElementById('phoneCameraPreviewContainer');

    const logArea = document.getElementById('logArea');
    const lastCapturedImage = document.getElementById('lastCapturedImage');
    const lastCapturedText = document.getElementById('lastCapturedText');

    let socket = null;
    let phoneStreamInterval = null;
    let localMediaStream = null;
    const MAX_LOG_LINES = 100;

    function addLogMessage(message, level = "info") {
        const timestamp = new Date().toLocaleTimeString();
        const logEntry = document.createElement('div');
        logEntry.classList.add(`log-${level}`);
        logEntry.textContent = `[${timestamp}] ${message}`;
        logArea.appendChild(logEntry);
        if (logArea.children.length > MAX_LOG_LINES) {
            logArea.removeChild(logArea.firstChild);
        }
        logArea.scrollTop = logArea.scrollHeight;
    }

    function connectSocket() {
        if (!socket || !socket.connected) {
            socket = io({transports: ['websocket'], upgrade: false});
            socket.on('connect', () => { addLogMessage('Socket.IO connected.', 'success'); });
            socket.on('disconnect', () => { addLogMessage('Socket.IO disconnected.', 'warn'); });
            socket.on('connect_error', (err) => { addLogMessage(`Socket.IO connection error: ${err.message}`, 'error');});
            socket.on('new_log', function(data) { addLogMessage(data.message, data.level); });
            socket.on('new_plate_saved', function(data) {
                addLogMessage(`New plate saved: ${data.filename} - Text: ${data.text} (Score: ${data.score})`, 'success');
                lastCapturedImage.src = `/get_image/${data.filename}?t=${new Date().getTime()}`;
                lastCapturedText.textContent = `Text: ${data.text} (Score: ${data.score})`;
            });
        }
    }

    function stopPhoneCameraStream() {
        if (phoneStreamInterval) { clearInterval(phoneStreamInterval); phoneStreamInterval = null; }
        if (localMediaStream) { localMediaStream.getTracks().forEach(track => track.stop()); localMediaStream = null; }
        phoneCameraPreviewContainer.classList.add('hidden');
        phoneCameraPreview.srcObject = null;
        addLogMessage("Phone camera stream stopped.");
    }

    startIpCamButton.onclick = function() {
        stopPhoneCameraStream();
        const ipCameraUrl = ipCameraUrlInput.value.trim();
        const camId = cameraIdInput.value.trim() || 'server_cam_default';
        const loc = locationSelect.value; // Get value from select dropdown

        let sourceParam = 'local';
        if (ipCameraUrl && ipCameraUrl.toLowerCase() !== 'local') {
            sourceParam = ipCameraUrl;
        }

        videoFeedImg.src = `{{ url_for('video_feed_route') }}?source=${encodeURIComponent(sourceParam)}&id=${encodeURIComponent(camId)}&location=${encodeURIComponent(loc)}&t=${new Date().getTime()}`;
        streamStatus.textContent = `Attempting Cam: ${camId} at ${loc} (Source: ${ipCameraUrl || "local"})`;
        addLogMessage(`Starting stream from Cam ID: ${camId}, Location: ${loc}, Source: ${ipCameraUrl || "local"}`);
    };

    startPhoneCamButton.onclick = async function() {
        connectSocket();
        phoneCameraPreviewContainer.classList.remove('hidden');
        streamStatus.textContent = "Requesting phone camera...";
        addLogMessage("Requesting phone camera access...");

        const camId = cameraIdInput.value.trim() || 'phone_cam_user';
        const loc = locationSelect.value; // Get value from select dropdown for phone camera too

        try {
            if (localMediaStream) { localMediaStream.getTracks().forEach(track => track.stop()); }
            localMediaStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
            phoneCameraPreview.srcObject = localMediaStream;
            addLogMessage("Phone camera access granted.", "success");
            streamStatus.textContent = "Streaming from phone to server...";
            videoFeedImg.src = `{{ url_for('video_feed_route') }}?source=phone_stream&id=${encodeURIComponent(camId)}&location=${encodeURIComponent(loc)}&t=${new Date().getTime()}`;

            if (phoneStreamInterval) clearInterval(phoneStreamInterval);

            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            phoneStreamInterval = setInterval(() => {
                if (phoneCameraPreview.readyState === phoneCameraPreview.HAVE_ENOUGH_DATA) {
                    canvas.width = phoneCameraPreview.videoWidth;
                    canvas.height = phoneCameraPreview.videoHeight;
                    context.drawImage(phoneCameraPreview, 0, 0, canvas.width, canvas.height);
                    const dataUrl = canvas.toDataURL('image/jpeg', 0.6);
                    if (socket && socket.connected) {
                        socket.emit('phone_frame_stream', { image_data: dataUrl });
                    }
                }
            }, 150);
        } catch (err) {
            console.error("Error accessing phone camera:", err);
            addLogMessage(`Error accessing phone camera: ${err.message}`, 'error');
            streamStatus.textContent = "Error: Could not access phone camera.";
            phoneCameraPreviewContainer.classList.add('hidden');
        }
    };

    videoFeedImg.onload = function() {
        if (videoFeedImg.src && videoFeedImg.src.includes("source=")) {
             const urlParams = new URLSearchParams(new URL(videoFeedImg.src).search);
             const location = urlParams.get('location');
             if (videoFeedImg.src.includes("source=phone_stream")) {
                streamStatus.textContent = `Phone stream active for ${location}. (Preview on phone)`;
            } else {
                 streamStatus.textContent = `Streaming from IP/Server Cam for ${location}.`;
            }
        } else {
            streamStatus.textContent = "Stream stopped or not yet started.";
        }
        videoFeedImg.style.backgroundColor = 'transparent';
    };

    videoFeedImg.onerror = function() {
        streamStatus.textContent = "Error loading processed stream. Check server console.";
        addLogMessage("Error loading processed video stream from server.", "error");
        videoFeedImg.style.backgroundColor = '#500'; // Reddish background for error
    };

    window.onload = function() {
        streamStatus.textContent = "Select a camera source to start.";
        addLogMessage("ANPR Interface Loaded. Please select a camera source.");
        connectSocket();
        // If you want to automatically start with the first location from the dropdown:
        // startIpCamButton.click(); // Uncomment to auto-start, ensure default values are okay
    };
</script>
</body>
</html>